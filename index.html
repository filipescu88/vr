<html>
  <head>
    <title>Joystick Fly</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script>
      AFRAME.registerComponent('fly-with-joystick-full', {
        schema: {
          speed: {type: 'number', default: 0.1}
        },
        init: function () {
          this.rig = this.el;
          this.camera = document.querySelector('#camera');
        },
        tick: function () {
          const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
          if (!gamepads) return;

          const gp = gamepads[0]; // kontroler pod indexem 0
          if (!gp) return;

          const yAxis = gp.axes[1]; // pionowa oś joysticka
          const xAxis = gp.axes[0]; // pozioma oś joysticka

          if (Math.abs(yAxis) > 0.1 || Math.abs(xAxis) > 0.1) {
            const cameraObj = this.camera.object3D;
            const direction = new THREE.Vector3();
            cameraObj.getWorldDirection(direction);
            direction.normalize();

            // ruch w osi pionowej (góra-dół) zgodnie z kierunkiem kamery
            const upDown = direction.clone();

            // ruch w osi poziomej - boczne przesunięcie względem kierunku kamery
            const side = new THREE.Vector3();
            side.crossVectors(cameraObj.up, direction).normalize();

            // skalowanie kierunków przez wartość osi joysticka
            const moveVector = new THREE.Vector3();
            moveVector.add(side.multiplyScalar(-xAxis));
            moveVector.add(upDown.multiplyScalar(-yAxis));

            moveVector.multiplyScalar(this.data.speed);

            // dodaj ruch do pozycji rig
            this.rig.object3D.position.add(moveVector);
          }
        }
      });
    </script>
  </head>
  <body>
    <a-scene vr-mode-ui="enabled: true" background="color: #ECECEC">
      
      <!-- Kamera + rig z nowym komponentem latania -->
      <a-entity id="rig" position="0 1.6 0" fly-with-joystick-full="speed: 0.1">
        <a-camera id="camera"></a-camera>
        
        <!-- Kontrolery Meta Touch -->
        <a-entity meta-touch-controls="hand: left" raycaster="objects: .clickable" line="color: green" id="leftController"></a-entity>
        <a-entity meta-touch-controls="hand: right" raycaster="objects: .clickable" line="color: blue" id="rightController"></a-entity>
      </a-entity>
      
      <!-- Klikalny box -->
      <a-box class="clickable" position="0 1.5 -3" color="red" depth="0.5" height="0.5" width="0.5"></a-box>
      
      <!-- Światło i podłoga -->
      <a-light type="ambient" color="#888"></a-light>
      <a-light type="directional" intensity="0.5" position="1 1 0.5"></a-light>
      <a-plane rotation="-90 0 0" width="10" height="10" color="#7BC8A4"></a-plane>
      
      <script>
        // Obsługa kliknięcia na box
        document.querySelectorAll('.clickable').forEach((el) => {
          el.addEventListener('click', () => {
            el.setAttribute('color', '#' + (Math.random() * 0xFFFFFF << 0).toString(16));
            console.log('Box clicked!');
          });
        });
      </script>
      
    </a-scene>
  </body>
</html>
